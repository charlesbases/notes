# Redis使用规范和最佳实践

# Redis 使用规范和最佳实践

Redis是一个开源的高性能键值存储数据库，被广泛应用于缓存、消息队列、计数器等场景。然而，为了充分发挥 Redis 的优势并保证应用的性能和可靠性，我们需要遵循一些使用规范。在开发过程中，Redis属于高频使用，开发人员将遇到各种各样的Redis问题。于是，我结合这些年在一线战斗的经验，梳理了一些 Redis 使用的规范和最佳实践，以帮助开发人员正确、高效地使用 Redis。

**写在最前面的2句话：**

*   有些人总是在灾难发生后，才想起容灾的重要性。
    
*   有些人总是在吃过亏后，才记得曾经有人提醒过。
    

# key-value 键名设计

1.  key名设计
    
    *   禁止包含特殊字符。比如：空格、换行、单双引号以及其他转义字符。
        
    *   建议以业务名为前缀，以冒号分割来构造一定规则的key名(比如：业务名:实体id的方式命名，eg: order:user\_id:21)。
        
    *   尽量控制好key的长度。如果key太长，用户量一大起来就会非常占用内存。
        
2.  value设计
    
    *   拒绝大key操作。禁用超过10K的string大key(虽然Redis支持512MB大小的string)。如果1MB的key每秒重复写入10次，就会导致写入网络IO达10MB。错误示范：直接将laravel的整个模型或者对象当成value存储。
        
    *   设计key时，需要使用合适的数据类型(在资源利用和性能之间作平衡)。错误示范：一个普通字符串弄成hash类型进行存储。
        
    *   一定要控制key的生命周期。错误示范：key设置为永不过期。
        
    *   控制value长度。比如string类型，如果value为"8个字节的长整型"则内部使用int类型，如果value为"小于等于39个字节的字符串"，则内部使用embstr类型，如果value为"大于39个字节的字符串"，则内部使用raw类型。这样能很好的利用Redis的性能。
        
    *   数据按需存储。不需要的数据千万不要存储在Redis中，因为它会浪费内存空间。
        

# Redis 命令使用特殊说明

1.  禁止使用keys、flushall、hmgetall等命令。为防止业务研发的误操作，通常可以在交付Redis实例之前，将默认命令rename掉；而真正需要删除或者遍历key时，可以使用scan/hscan等命令。
    
2.  一般来说，慎用hgetall、lrange、smembers、zrange等命令。除非业务场景需要，尽量不要使用这些命令。如果没有控制好，可能会导致操作量过大，形成Redis阻塞。
    

# Redis 缓存设计

1.  多个库的使用。如果应用中会涉及到各种不同的Redis数据存储，应该分库存储，最好是一种业务使用一个库。比如：课程缓存:库1；订单队列:库2；日志处理:库3
    
2.  避免多个服务公用一个Redis实例。这样能有效避免一个应用出现问题或者错误使用拖累其他应用。
    
3.  合理评估业务场景，并设置最大内存，以及内存淘汰策略(maxmemory和maxmemory-policy)。对于开发来说，我们大多使用的是腾讯云、阿里云上面的Redis，基本上不存在这个问题。
    
4.  使用带有连接池的数据库，可以有效控制连接，同时提高效率。
    
5.  给Redis设置一个密码。例如：腾讯云、阿里云Redis处于安全性考虑，通常都会建议业务使用password来连接Redis。
    
6.  做好冷热数据区分。虽然Redis支持持久化，但将所有数据存储在Redis中，成本非常昂贵。建议将热数据(例如：QPS超过1k+)的数据加载到Redis中。低频数据可存储在MySQL数据库或ElasticSearch中。
    
7.  缓存非特殊情况，不做中间态。Redis大多数都是做缓存用，去掉后业务逻辑不应发生改变，万不可深度切入到业务里。原因如下：
    
    *   缓存的高可用会影响业务；
        
    *   产生深耦合会发生无法预料的效果；
        
    *   会对应用维护和拓展产生负效果。
        

# Redis 实战场景问题说明

1.  项目Redis使用问题。有的团队是每个接入的应用都配置核心项目的Redis配置。这样做是不合理的，核心项目的Redis应该只能在核心项目中使用，对外应该是提供api接口或者rpc进行访问。
    
2.  慎用laravel自带的cache功能。例如：laravel自带的cache功能最容易导致大key，经常由于简单使用至今将整个对象模型存储到Redis，造成大key，甚至发生Redis oom现象。
    
3.  注意key的过期时间设置。特别是在活动、报名等高峰期的时候，key值设置过短很容易造成缓存穿透，导致大量请求直接打到MySQL数据库。
    
4.  小心Redis缓存穿透。有时候，只给有数据的结果进行缓存，结果导致空数据无法缓存。相同查询直接每次都到达数据库，所以空值也应该被缓存。
    
5.  慎用缓存层层包裹。缓存里面的数据还有一层缓存数据，会导致问题排查麻烦，出问题也不容易处理。
    
6.  慎用将Redis list做为消息队列。例如：如果业务层面没有非常特殊的需求，严禁将Redis当作消息队列使用。
    
    *   Redis当作消息队列使用，会有容量、网络、效率、功能方面的多种问题。
        
    *   如需要消息队列，可使用高吞吐的 Kafka 或者高可靠的 RocketMQ，nsq,(花园同步有时间前后要求，且量不大才使用的)。
        
7.  线上Redis禁止使用Keys正则匹配操作。Redis是单线程处理，在线上Key数量较多时，操作效率极低【时间复杂度为O(N)】，该命令一旦执行会严重阻塞线上其它命令的正常请求，而且在高QPS情况下会直接造成Redis服务崩溃！如果有类似需求，请使用scan或者hscan命令代替。
    

# Redis 最佳实践

1.  选择正确的数据结构 Redis 提供了多种数据结构，如字符串、哈希表、列表、集合、有序集合等。在使用 Redis 时，根据实际需求选择正确的数据结构非常重要。例如，如果需要存储一组唯一的元素，可以选择集合；如果需要排序和范围查询，可以选择有序集合。合理选择数据结构可以提高性能和降低存储空间的占用。
    
2.  合理设置数据过期时间 Redis 具有自动过期功能，可以设置键的过期时间。在使用 Redis 缓存数据时，需要根据业务需求合理设置过期时间。过期时间过长可能导致缓存的数据不及时，过期时间过短可能导致频繁的缓存失效和重新加载。根据数据的更新频率和业务特点，选择适当的过期时间，以平衡性能和数据实时性。
    
3.  使用管道和批量操作 Redis 支持管道和批量操作，可以显著提高性能。通过使用管道，可以将多个命令一次性发送到 Redis 服务器，减少网络通信开销。而批量操作可以一次性执行多个命令，避免了每个命令的网络延迟。在需要批量读取、写入或删除数据时，使用管道和批量操作可以显著提升性能。
    
4.  合理使用缓存预热 缓存预热是在系统启动或低峰期加载缓存数据，以提高系统性能和响应速度。通过在系统启动时加载常用的数据到 Redis 缓存中，可以避免首次访问的冷启动问题。合理使用缓存预热可以降低数据库的压力，提高系统的稳定性和用户体验。
    
5.  注意防止缓存穿透 缓存穿透是指恶意请求或非法请求导致缓存无效，导致每次请求都直接访问数据库。为了防止缓存穿透，可以采取以下措施：
    

*   使用布隆过滤器（Bloom Filter）来过滤掉不存在的数据，减轻对数据库的压力。
    
*   对查询结果为空的情况也进行缓存，设置一个较短的过期时间，避免频繁查询数据库。
    

1.  避免缓存击穿 缓存击穿是指一个热点数据失效后，大量请求同时访问数据库，导致数据库负载过高。为了避免缓存击穿，可以采取以下措施：
    

*   使用互斥锁（Mutex）或分布式锁来控制对数据库的并发访问，保证只有一个请求能够重新加载数据。
    
*   对热点数据的过期时间进行随机化，避免大量请求同时访问数据库。
    

1.  合理使用 Redis 的持久化机制 Redis 提供了两种持久化机制：RDB（Redis Database）和AOF（Append-Only File）。RDB是将内存中的数据快照保存到磁盘上，而AOF是将写操作追加到文件中。在选择持久化机制时，需要根据数据的重要性、恢复速度和持久化效果等因素进行评估。另外，还需要定期备份Redis 数据库，以防止数据丢失。
    
2.  配置 Redis 的最大内存限制 Redis 使用内存作为数据存储，因此需要合理配置最大内存限制，防止内存溢出和系统崩溃。可以通过配置文件或命令行参数来设置 Redis 的最大内存限制。当达到最大内存限制时，Redis 提供了不同的策略来处理新写入的数据，如删除最近最少使用的数据（LRU算法）或随机删除数据。根据实际需求和系统资源，合理设置最大内存限制，以保证系统的稳定性和性能。
    
3.  使用 Redis 事务 Redis 支持事务操作，可以保证一组命令的原子性执行。通过使用事务，可以将一系列命令作为一个原子操作进行提交或回滚。事务可以确保在执行期间没有其他客户端可以修改被事务操作的数据。使用 Redis 事务可以保证数据的一致性和可靠性。
    
4.  监控和优化 Redis 性能 对于高性能和稳定性的要求，需要监控和优化 Redis 的性能。可以使用 Redis 自带的监控工具或第三方工具来监控 Redis 的各项指标，如内存使用、连接数、命令执行时间等。根据监控结果，进行调优和优化，例如合理设置内存、调整配置参数、使用连接池、优化查询等。定期进行性能测试和调优可以提高 Redis 的性能和可靠性。
    

# 关于big key说明

### big key的危害：

*   导致redis阻塞
    
*   网络拥塞
    

bigkey也就意味着每次获取要产生的网络流量较大；假设一个bigkey为1MB，客户端每秒访问量为1000，那么每秒产生1000MB的流量，对于普通的千兆网卡(按照字节算是128MB/s)的服务器来说简直是灭顶之灾，而且一般服务器会采用单机多实例的方式来部署，也就是说一个bigkey可能会对其他实例也造成影响，其后果不堪设想。

*   过期删除
    

假设有个bigkey，它安分守己（只执行简单的命令，例如hget、lpop、zscore等），但它设置了过期时间，当它过期后，会被删除，如果没有使用Redis 4.0的过期异步删除(lazyfree-lazy- expire yes)，就会存在阻塞Redis的可能性。

### big key的产生：

一般来说，bigkey的产生都是由于程序设计不当，或者对于数据规模预料不清楚造成的，来看几个例子：

*    社交类： 粉丝列表，如果某些明星或者大v不精心设计下，必是bigkey。
    
*   统计类： 例如按天存储某项功能或者网站的用户集合，除非没几个人用，否则必是bigkey。
    
*   缓存类： 将数据从数据库load出来序列化放到Redis里，这个方式非常常用，但有两个地方需要注意，第一，是不是有必要把所有字段都缓存；第二，有没有相关关联的数据，有的同学为了图方便把相关数据都存一个key下，产生bigkey。
    

### 如何优化big key

**1、【推荐】将大key适当拆分为小key**

如果是大List（big list），那么就可以拆成多个List：

比如拆成：list1、list2、...listN

如果是一个大的哈希表（big hash）,可以将数据分段存储：

比如一个大的key，假设存了1百万的用户数据，可以拆分成 200个key，每个key下面存放5000个用户数据

如果big key不可避免，也要思考一下要不要每次把所有元素都取出来(例如有时候仅仅需要 hmget，而不是hgetall)，删除也是一样，尽量使用优雅的方式来处理。

**2、【推荐】选择合适的数据类型**

最好的优化方案其实是在设计阶段，所以我们在使用Redis时，在设计阶段就应该尽量避免bigkey，所以选择合适的数据类型尤为重要。

例如：实体类型（要合理控制和使用数据结构，但也要注意节省内存和性能质检的平衡）

错误的做法：

```shell
hset user:1:name tom
hset user:1:age 19
hset user:1:favor football
```

正确的做法：

```shell
hmset user:1 name tom age 19 favor football
```

**3、【推荐】控制key的生命周期，redis不是垃圾桶，当不需要使用的数据，及时过期清理**

建议使用Expire设置过期时间。条件允许可以打散过期时间，防止几种过期比如：设置key的过期时间时，采用固定过期时间+一定范围内的随机数。

# Redis开发人员和运维人员操作规范

## 开发操作规范：

1、接入Redis 必须加前缀，分为两段。

2、此接入限非核心业务，并且只做cache

3、单个value不大于1MB

4、请大家尽量分散key的使用，不要产生热点key

5､ 所有的key设置过期时间

6､ 禁止使用运维类的命令 keys monitor debug watch flush bigkeys

7､ 不使用多个db,只使用db0

8､ 注意节约内存，value尽量都是整型

## 运维操作规范：

1､切忌多个应用使用一个Redis实例

2､事先做好容量规划

3､所有接入的业务都要强制使用前缀

4､不要使用rdb，使用aof

5､aof重写不要让Redis自己触发，应选择在业务低峰期脚本触发

6､重要命令重命名，如: keys

7､注意观察慢查询日志

8､避免产生大key，导致网卡打爆、慢查询

9､避免产生死key，导致内存不够使用

10､避免产生热点key，导致单个实例成为短板

10､单个实例不要超过物理机内存的50%

# 总结

Redis 是一个强大而灵活的键值存储数据库，合理使用 Redis 可以显著提高系统的性能和可靠性。上面介绍了一些 Redis 使用的规范和最佳实践，包括选择正确的数据结构、设置数据过期时间、使用管道和批量操作等。如果我们在实际开发过程中，遵循这些规范和最佳实践，就可以充分发挥 Redis 的优势，并确保应用程序的高性能和可靠性。希望上面的内容，对您在使用 Redis 过程中有所帮助，并能够在实际项目中正确地应用这些规范。